# frozen_string_literal: true

require './spec/spec_helper'

describe SprintBurndown do
  let(:board) { load_complete_sample_board }
  let(:sprint_burndown) do
    described_class.new.tap do |chart|
      # Larger than the sprint
      chart.time_range = to_time('2022-03-01')..to_time('2022-04-11T23:59:59 +00:00')
      chart.date_range = chart.time_range.begin.to_date..chart.time_range.end.to_date
      chart.all_boards = { board.id => board }
    end
  end

  let(:sprint) do
    Sprint.new(raw: {
      'id' => 1,
      'self' => 'https://improvingflow.atlassian.net/rest/agile/1.0/sprint/1',
      'state' => 'active',
      'name' => 'Scrum Sprint 1',
      'activatedDate' => '2022-03-26T00:00:00z',
      'endDate' => '2022-04-09T00:00:00z',
      'originBoardId' => 2,
      'goal' => 'Do something'
    }, timezone_offset: '+00:00')
  end

  context 'options' do
    it 'handles points_only' do
      sprint_burndown.options = :points_only
      expect([sprint_burndown.use_story_points, sprint_burndown.use_story_counts]).to eq([true, false])
    end

    it 'handles counts_only' do
      sprint_burndown.options = :counts_only
      expect([sprint_burndown.use_story_points, sprint_burndown.use_story_counts]).to eq([false, true])
    end

    it 'handles points_and_counts' do
      sprint_burndown.options = :points_and_counts
      expect([sprint_burndown.use_story_points, sprint_burndown.use_story_counts]).to eq([true, true])
    end

    it 'handles neither' do
      expect { sprint_burndown.options = :foo }.to raise_error 'Unexpected option: foo'
    end
  end

  context 'changes_for_one_issue' do
    let(:issue) { load_issue('SP-1', board: board).tap { |issue| issue.changes.clear } }

    it 'returns empty list for no changes' do
      board.cycletime = mock_cycletime_config stub_values: []
      expect(sprint_burndown.changes_for_one_issue(issue: issue, sprint: sprint)).to be_empty
    end

    it 'returns start and end only' do
      board.cycletime = mock_cycletime_config stub_values: [
        [issue, '2022-01-01', '2022-02-01']
      ]
      add_mock_change(issue: issue, field: 'Sprint', value: sprint.name, value_id: sprint.id.to_s, time: '2022-01-03')
      add_mock_change(issue: issue, field: 'Sprint', value: '', value_id: '', time: '2022-01-04')
      expect(sprint_burndown.changes_for_one_issue(issue: issue, sprint: sprint)).to eql [
        SprintIssueChangeData.new(
          action: :enter_sprint, time: to_time('2022-01-03'), value: 0.0, issue: issue, story_points: 0.0
        ),
        SprintIssueChangeData.new(
          action: :leave_sprint, time: to_time('2022-01-04'), value: 0.0, issue: issue, story_points: 0.0
        )
      ]
    end

    it 'changes points at various times for item that was in sprint from the beginning' do
      board.cycletime = mock_cycletime_config stub_values: [
        [issue, '2022-01-01', '2022-01-05']
      ]
      add_mock_change(issue: issue, field: 'Sprint', value: sprint.name, value_id: sprint.id.to_s, time: '2022-01-01')
      add_mock_change(issue: issue, field: 'Story Points', value: 2.0, old_value: nil, time: '2022-01-02')
      sprint.raw['activatedDate'] = '2021-01-03'
      add_mock_change(issue: issue, field: 'Story Points', value: 4.0, old_value: 2.0, time: '2022-01-04')
      # Issue closes on Jan 5
      add_mock_change(issue: issue, field: 'status', value: 'Done', value_id: 10_002, time: '2022-01-05')
      add_mock_change(issue: issue, field: 'Story Points', value: '6.0', time: '2022-01-06')

      expect(sprint_burndown.changes_for_one_issue(issue: issue, sprint: sprint)).to eql [
        SprintIssueChangeData.new(
          action: :enter_sprint, time: to_time('2022-01-01'), value: 0.0, issue: issue, story_points: 0.0
        ),
        SprintIssueChangeData.new(
          action: :story_points, time: to_time('2022-01-02'), value: 2.0, issue: issue, story_points: 2.0
        ),
        SprintIssueChangeData.new(
          action: :story_points, time: to_time('2022-01-04'), value: 2.0, issue: issue, story_points: 4.0
        ),
        SprintIssueChangeData.new(
          action: :issue_stopped, time: to_time('2022-01-05'), value: -4.0, issue: issue, story_points: 4.0
        )
      ]
    end
  end

  context 'data_set_by_story_points' do
    let(:issue1) { load_issue('SP-1').tap { |issue| issue.changes.clear } }
    let(:issue2) { load_issue('SP-2').tap { |issue| issue.changes.clear } }

    it 'handles an empty active sprint' do
      change_data = []
      expect(sprint_burndown.data_set_by_story_points(change_data_for_sprint: change_data, sprint: sprint)).to eq [
        { x: '2022-03-26T00:00:00+0000', y: 0.0, title: 'Sprint started with 0.0 points' },
        { x: '2022-04-11T23:59:59+0000', y: 0.0, title: 'Sprint still active. 0.0 points still in progress.' }
      ]
    end

    it 'handles an empty completed sprint' do
      change_data = []
      sprint.raw['completeDate'] = '2022-04-10T00:00:00z'
      expect(sprint_burndown.data_set_by_story_points(change_data_for_sprint: change_data, sprint: sprint)).to eq [
        { x: '2022-03-26T00:00:00+0000', y: 0.0, title: 'Sprint started with 0.0 points' },
        { x: '2022-04-10T00:00:00+0000', y: 0.0, title: 'Sprint ended with 0.0 points unfinished' }
      ]
    end

    it 'handles complex case with active sprint' do
      change_data = [
        # Sprint start is 2022-03-26

        SprintIssueChangeData.new( # Has points assigned but not in sprint at start
          time: to_time('2022-03-23'), action: :story_points, value: 2.0, issue: issue2, story_points: 2.0
        ),

        SprintIssueChangeData.new(
          time: to_time('2022-03-23'), action: :story_points, value: 5.0, issue: issue1, story_points: 5.0
        ),
        SprintIssueChangeData.new(
          time: to_time('2022-03-24'), action: :story_points, value: 7.0, issue: issue1, story_points: 12.0
        ),
        SprintIssueChangeData.new(
          time: to_time('2022-03-25'), action: :enter_sprint, value: 5.0, issue: issue1, story_points: 12.0
        ),

        # sprint starts here

        SprintIssueChangeData.new(
          time: to_time('2022-03-27'), action: :story_points, value: 5.0, issue: issue1, story_points: 5.0
        ),
        SprintIssueChangeData.new( # Should be ignored because it's in sprint yet
          time: to_time('2022-03-27'), action: :story_points, value: 2.0, issue: issue2, story_points: 4.0
        ),
        SprintIssueChangeData.new(
          time: to_time('2022-03-28'), action: :enter_sprint, value: nil, issue: issue2, story_points: 4.0
        )
      ]
      expect(sprint_burndown.data_set_by_story_points(change_data_for_sprint: change_data, sprint: sprint)).to eq [
        { x: '2022-03-26T00:00:00+0000', y: 12.0, title: 'Sprint started with 12.0 points' },
        { x: '2022-03-27T00:00:00+0000', y: 17.0, title: 'SP-1 Story points changed from 0.0 points to 5.0 points' },
        { x: '2022-03-28T00:00:00+0000', y: 21.0, title: 'SP-2 Added to sprint with 4.0 points' },
        { x: '2022-04-11T23:59:59+0000', y: 21.0, title: 'Sprint still active. 21.0 points still in progress.' }
      ]
    end

    it 'ignores changes after sprint end' do
      sprint.raw['completeDate'] = '2022-04-10T00:00:00z'
      change_data = [
        # Sprint start is 2022-03-26, end is 2022-04-10

        SprintIssueChangeData.new(
          time: to_time('2022-03-23'), action: :story_points, value: 5.0, issue: issue1, story_points: 5.0
        ),
        SprintIssueChangeData.new(
          time: to_time('2022-03-25'), action: :enter_sprint, value: 5.0, issue: issue1, story_points: 5.0
        ),

        # sprint starts and then ends here

        SprintIssueChangeData.new(
          time: to_time('2022-04-11'), action: :story_points, value: -2.0, issue: issue1, story_points: 3.0
        )
      ]
      expect(sprint_burndown.data_set_by_story_points(change_data_for_sprint: change_data, sprint: sprint)).to eq [
        { x: '2022-03-26T00:00:00+0000', y: 5.0, title: 'Sprint started with 5.0 points' },
        { x: '2022-04-10T00:00:00+0000', y: 5.0, title: 'Sprint ended with 5.0 points unfinished' }
      ]
    end

    it 'handles an issue being removed mid-sprint' do
      sprint.raw['completeDate'] = '2022-04-10T00:00:00z'
      change_data = [
        # Sprint start is 2022-03-26, end is 2022-04-10

        SprintIssueChangeData.new(
          time: to_time('2022-03-24'), action: :enter_sprint, value: 5.0, issue: issue1, story_points: 5.0
        ),
        SprintIssueChangeData.new(
          time: to_time('2022-03-25'), action: :enter_sprint, value: 7.0, issue: issue2, story_points: 7.0
        ),

        # sprint starts

        SprintIssueChangeData.new(
          time: to_time('2022-03-27'), action: :leave_sprint, value: -5.0, issue: issue1, story_points: 5.0
        )
      ]
      expect(sprint_burndown.data_set_by_story_points(change_data_for_sprint: change_data, sprint: sprint)).to eq [
        { x: '2022-03-26T00:00:00+0000', y: 12.0, title: 'Sprint started with 12.0 points' },
        { x: '2022-03-27T00:00:00+0000', y: 7.0, title: 'SP-1 Removed from sprint with 5.0 points' },
        { x: '2022-04-10T00:00:00+0000', y: 7.0, title: 'Sprint ended with 7.0 points unfinished' }
      ]
    end

    it 'handles an issue being completed mid-sprint' do
      sprint.raw['completeDate'] = '2022-04-10T00:00:00z'
      change_data = [
        # Sprint start is 2022-03-26, end is 2022-04-10

        SprintIssueChangeData.new(
          time: to_time('2022-03-24'), action: :enter_sprint, value: 5.0, issue: issue1, story_points: 5.0
        ),
        SprintIssueChangeData.new(
          time: to_time('2022-03-25'), action: :enter_sprint, value: 7.0, issue: issue2, story_points: 7.0
        ),

        # sprint starts

        SprintIssueChangeData.new(
          time: to_time('2022-03-27'), action: :issue_stopped, value: -5.0, issue: issue1, story_points: 5.0
        )
      ]
      expect(sprint_burndown.data_set_by_story_points(change_data_for_sprint: change_data, sprint: sprint)).to eq [
        { x: '2022-03-26T00:00:00+0000', y: 12.0, title: 'Sprint started with 12.0 points' },
        { x: '2022-03-27T00:00:00+0000', y: 7.0, title: 'SP-1 Completed with 5.0 points' },
        { x: '2022-04-10T00:00:00+0000', y: 7.0, title: 'Sprint ended with 7.0 points unfinished' }
      ]
    end

    it 'handles an issue with zero points being completed mid-sprint' do
      sprint.raw['completeDate'] = '2022-04-10T00:00:00z'
      change_data = [
        # Sprint start is 2022-03-26, end is 2022-04-10

        SprintIssueChangeData.new(
          time: to_time('2022-03-24'), action: :enter_sprint, value: 0.0, issue: issue1, story_points: 0.0
        ),
        SprintIssueChangeData.new(
          time: to_time('2022-03-25'), action: :enter_sprint, value: 7.0, issue: issue2, story_points: 7.0
        ),

        # sprint starts

        SprintIssueChangeData.new(
          time: to_time('2022-03-27'), action: :issue_stopped, value: 0.0, issue: issue1, story_points: 0.0
        )
      ]
      expect(sprint_burndown.data_set_by_story_points(change_data_for_sprint: change_data, sprint: sprint)).to eq [
        { x: '2022-03-26T00:00:00+0000', y: 7.0, title: 'Sprint started with 7.0 points' },
        { x: '2022-03-27T00:00:00+0000', y: 7.0, title: 'SP-1 Completed with 0.0 points' },
        { x: '2022-04-10T00:00:00+0000', y: 7.0, title: 'Sprint ended with 7.0 points unfinished' }
      ]
    end

    it 'raises error if an illegal action is passed in' do
      sprint.raw['completeDate'] = '2022-04-10T00:00:00z'
      change_data = [
        SprintIssueChangeData.new(
          time: to_time('2022-03-28'), action: :illegal_action, value: 0.0, issue: issue1, story_points: 0.0
        )
      ]
      expect { sprint_burndown.data_set_by_story_points(change_data_for_sprint: change_data, sprint: sprint) }.to(
        raise_error 'Unexpected action: illegal_action'
      )
    end
  end

  context 'data_set_by_story_counts' do
    let(:issue1) { load_issue('SP-1').tap { |issue| issue.changes.clear } }
    let(:issue2) { load_issue('SP-2').tap { |issue| issue.changes.clear } }

    it 'handles an empty active sprint' do
      change_data = []
      expect(sprint_burndown.data_set_by_story_counts(change_data_for_sprint: change_data, sprint: sprint)).to eq [
        { x: '2022-03-26T00:00:00+0000', y: 0, title: 'Sprint started with 0 stories' },
        { x: '2022-04-11T23:59:59+0000', y: 0, title: 'Sprint still active. 0 issues in progress.' }
      ]
    end

    it 'handles an empty completed sprint' do
      change_data = []
      sprint.raw['completeDate'] = '2022-04-10T00:00:00z'
      expect(sprint_burndown.data_set_by_story_counts(change_data_for_sprint: change_data, sprint: sprint)).to eq [
        { x: '2022-03-26T00:00:00+0000', y: 0, title: 'Sprint started with 0 stories' },
        { x: '2022-04-10T00:00:00+0000', y: 0, title: 'Sprint ended with 0 stories unfinished' }
      ]
    end

    it 'handles complex case with active sprint' do
      change_data = [
        # Sprint start is 2022-03-26

        SprintIssueChangeData.new(
          time: to_time('2022-03-25'), action: :enter_sprint, value: 5.0, issue: issue1, story_points: 12.0
        ),

        # sprint starts here

        SprintIssueChangeData.new(
          time: to_time('2022-03-28'), action: :enter_sprint, value: nil, issue: issue2, story_points: 4.0
        )
      ]
      expect(sprint_burndown.data_set_by_story_counts(change_data_for_sprint: change_data, sprint: sprint)).to eq [
        { x: '2022-03-26T00:00:00+0000', y: 1.0, title: 'Sprint started with 1 stories' },
        { x: '2022-03-28T00:00:00+0000', y: 2.0, title: 'SP-2 Added to sprint' },
        { x: '2022-04-11T23:59:59+0000', y: 2.0, title: 'Sprint still active. 2 issues in progress.' }
      ]
    end

    it 'handles an issue being removed mid-sprint' do
      sprint.raw['completeDate'] = '2022-04-10T00:00:00z'
      change_data = [
        # Sprint start is 2022-03-26, end is 2022-04-10

        SprintIssueChangeData.new(
          time: to_time('2022-03-24'), action: :enter_sprint, value: nil, issue: issue1, story_points: 5.0
        ),
        SprintIssueChangeData.new(
          time: to_time('2022-03-25'), action: :enter_sprint, value: nil, issue: issue2, story_points: 7.0
        ),

        # sprint starts

        SprintIssueChangeData.new(
          time: to_time('2022-03-27'), action: :leave_sprint, value: nil, issue: issue1, story_points: 5.0
        )
      ]
      expect(sprint_burndown.data_set_by_story_counts(change_data_for_sprint: change_data, sprint: sprint)).to eq [
        { x: '2022-03-26T00:00:00+0000', y: 2, title: 'Sprint started with 2 stories' },
        { x: '2022-03-27T00:00:00+0000', y: 1, title: 'SP-1 Removed from sprint' },
        { x: '2022-04-10T00:00:00+0000', y: 1, title: 'Sprint ended with 1 stories unfinished' }
      ]
    end

    it 'handles an issue being completed mid-sprint and should ignore one after sprint end' do
      sprint.raw['completeDate'] = '2022-04-10T00:00:00z'
      change_data = [
        # Sprint start is 2022-03-26, end is 2022-04-10

        SprintIssueChangeData.new(
          time: to_time('2022-03-24'), action: :enter_sprint, value: 5.0, issue: issue1, story_points: 5.0
        ),
        SprintIssueChangeData.new(
          time: to_time('2022-03-25'), action: :enter_sprint, value: 7.0, issue: issue2, story_points: 7.0
        ),

        # sprint starts

        SprintIssueChangeData.new( # This should be ignored
          time: to_time('2022-03-27'), action: :story_points, value: 4.0, issue: issue1, story_points: 9.0
        ),
        SprintIssueChangeData.new(
          time: to_time('2022-03-28'), action: :issue_stopped, value: -5.0, issue: issue1, story_points: 5.0
        ),

        # sprint ends

        SprintIssueChangeData.new(
          time: to_time('2022-04-11'), action: :issue_stopped, value: -7.0, issue: issue1, story_points: 7.0
        )

      ]
      expect(sprint_burndown.data_set_by_story_counts(change_data_for_sprint: change_data, sprint: sprint)).to eq [
        { x: '2022-03-26T00:00:00+0000', y: 2, title: 'Sprint started with 2 stories' },
        { x: '2022-03-28T00:00:00+0000', y: 1, title: 'SP-1 Completed' },
        { x: '2022-04-10T00:00:00+0000', y: 1, title: 'Sprint ended with 1 stories unfinished' }
      ]
    end
  end
end
